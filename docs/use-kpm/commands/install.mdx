import BelowDocument from "@site/src/components/BelowDocument";

# インストールコマンド

プラグインを新規インストールします。

---

## コマンド概要 - <kbd>/kpm install</kbd> {#overview}

プラグインを新規[インストール](/docs/expressions#install)します。

コマンドの実行結果と入力の説明は[こちら](#flow)を参照してください。

### エイリアス {#aliases}

- <kbd>i</kbd>

### コマンド構文 {#syntax}

- `install <クエリ>`

第一引数には、対象のプラグインの有効な[クエリ](/docs/use-kpm/features/query)を指定します。

### 権限 {#permissions}

- `kpm.install`
- `kpm.*`

### スクリーンショット {#screenshots}

![Multiple resolved#x180](images/install/multi-resolved.png)
![Installed resolved#x180](images/install/installed.png)


## インストールの流れ {#flow}

インストールコマンドを発行した後の KPM の動作と、ユーザが必要な操作を包括的に説明しています。

### 動作１. クエリを解決する {#resolve-query}

インストール対象のプラグインの .jar ファイルをダウンロードするために、クエリを解決し直リンクを入手します。  

また、プラグインの候補が複数ある場合、インストーラはそれらを全て表示して選択を促します。

![Multiple resolved#x180](images/install/multi-resolved.png)

#### 選択肢 {#resolve-query-choices}

選択は、チャットまたはコンソールに選択肢をそのまま入力します。

:::caution

`/` や `＊` などの接頭辞は入力する必要ありません。

:::

- <code><kbd>0</kbd>. - ...</code> や、 <code><kbd>1</kbd>. - ...</code> など、候補のインデックスがある選択肢<br />
  これは、通常のプラグインの候補です。基本的に、プラグインに複数のリリースまたはバージョンがある場合に表示されます。
- <code><kbd>a</kbd> - 自動で最適なプラグインを選択する</code><br />
  この選択肢を選ぶと、インストーラは自動で最適なプラグインを選択しようとします。  

  <BelowDocument docId="use-kpm/features/resolver"anchor="github"message={"基本的に最新のバージョンのプラグインが選択されますが詳しくは以下を参照してください。"}/>


- <code><kbd>c</kbd> - キャンセル</code><br />
  インストールをキャンセルします。

### 動作２. プラグインをダウンロードする {#download-plugin}

選択されたプラグインの .jar ファイルをダウンロードします。  
これに関して、特に選択肢はありません。

### 動作３. 環境をチェックする {#check-env}

KPM はプラグインとサーバ、および KPM に互換性があるかどうかを確認します。

チェックされる項目は以下の通りです：

+ プラグインが[除外リスト](/docs/use-kpm/getting-started/configuration#exclude)に含まれているかどうか
  
  プラグインが除外リストに含まれている場合、かつ強制的にインストールできる場合は、以下の選択肢が表示されます。  
  ![Screen shot#x100](images/general/excluded.png)
  - <code><kbd>y</kbd> - はい</code><br />
    警告を無視してプラグインをインストールします。
  
    :::warning
  
    この警告はシステムを保護するために表示されています。これを無視すると、予期しない問題を引き起こす可能性があります。
  
    :::
  - <code><kbd>n</kbd> - いいえ</code><br />
    インストールをキャンセルし、全てのキャッシュを破棄します。

+ プラグインが重複していないかどうか
  
  PaperMC（Bukkit） のプラグインは重複を許可しません。そのため、重複したプラグインはどちらか一方が適用されます。
  重複したプラグインをインストールしようとした場合、それぞれのプラグインの基本情報と、インストールを続行するかどうかを選ぶプロンプトが表示されます。
  
  ![Screen shot#x100](images/install/duplicated.png)
  - <code><kbd>y</kbd> - はい</code><br />
    警告を無視してプラグインをインストールします。
    
    :::warning
    
    この警告はシステムを保護するために表示されています。これを無視すると、予期しない問題を引き起こす可能性があります。
    
    :::
  - <code><kbd>n</kbd> - いいえ</code><br />
    インストールをキャンセルし、全てのキャッシュを破棄します。

+ [KPM 情報ファイル](/dev-docs/api/kpm-info)が正しいかどうか
  
  KPM は、正しい KPM 情報ファイルのみを受け入れます。間違った構文や、不正な値が含まれている場合、KPM はそれを無視しようとします。  
  このような場合、 インストールを続行するかどうかを選ぶプロンプトが表示されます。
  
  ![Screen shot#x100](images/install/invalid-kpm-info.png)
  - <code><kbd>y</kbd> - はい</code><br />
    警告を無視してプラグインをインストールします。
  
    :::warning
    
    この警告はシステムを保護するために表示されています。これを無視すると、予期しない問題を引き起こす可能性があります。
    
    :::
  - <code><kbd>n</kbd> - いいえ</code><br />
    インストールをキャンセルし、全てのキャッシュを破棄します。
  
  :::info
  
  プラグインが KPM 情報ファイルを持っていない場合、このチェックはスキップされます。
  <!-- TODO: KPM 情報ファイルの説明にリンク -->
  
  :::

### 動作４. 依存関係を解決する {#resolve-dependencies}

KPM は、上記の手順を依存関係に対しても行います。これは再帰的な操作です。

### 動作５. プラグインをダウンロードする {#download}

プラグインとその依存関係のビルドの成果物をキャシュにダウンロードします。  

:::tip

ダウンロードされたファイルは、ランダムな文字列 + .jar という名前で保存されます。

:::

### 動作６. プラグインをインストールする {#install}

KPM は、以下の手順に従って一つのプラグインをインストールします。

1. プラグインを `plugins/` ディレクトリに再配置する
2. プラグインのクラス・ローダーを作成し、 JAR ファイルを読み込む
3. プラグインの `onLoad()` メソッドを呼び出す
4. プラグインの `onEnable()` メソッドを呼び出す
5. プラグインのトリガを処理する

この手順は、依存関係のプラグインから順に実行され、最後に対象のプラグインがインストールされます。
また KPM は依存ツリーが深いプラグインから優先して読み込みます。
